dask:
  config: |
    from dask.distributed import Client
    from dask_kubernetes import KubeCluster
    from dask_kubernetes.objects import make_pod_from_dict, clean_pod_template
    from catlas.dask_utils import kube_cluster_new_worker
    import dask
    import os
    from jinja2 import Template
    
    dask.config.set({"distributed.comm.timeouts.connect":120})
    dask.config.set({"distributed.scheduler.allowed_failures":20})
    dask.config.set({"distributed.comm.retry.count":20})

    template = Template(open('configs/automated_screens/github-workers-gpu.tmpl').read())
    with open('./configs/automated_screens/github-workers-gpu.yml','w') as fhandle:
        fhandle.write(template.render(**os.environ))
    
    with open('configs/automated_screens/scheduler.yml') as f:
        scheduler_pod_template = make_pod_from_dict(dask.config.expand_environment_variables(
                    yaml.safe_load(f)
                ))

    cluster = KubeCluster(pod_template = 'configs/automated_screens/github-workers-gpu.yml',
                          scheduler_pod_template = scheduler_pod_template,
                          namespace='zulissi',
                          name='dask-catlas-{{ GITHUB_RUN_ID }}',
                          scheduler_service_wait_timeout = 120)
    cluster.scale(4)

    template = Template(open('configs/automated_screens/github-workers-cpu.tmpl').read())
    with open('./configs/automated_screens/github-workers-cpu.yml','w') as fhandle:
        fhandle.write(template.render(**os.environ))
    
    kube_cluster_new_worker(cluster, 'configs/automated_screens/github-workers-cpu.yml')
    cluster.scale(80)
    client = Client(cluster)

  partitions: -1 # Use automatic guess for number of partitions

memory_cache_location: '/home/jovyan/shared-scratch/catlas_cache_github'

output_options:
  pickle: True # True pickles the resulting predictions
  pickle_path: '/home/jovyan/shared-scratch/catlas/outputs/nitrides_CO2RR_{{ GITHUB_RUN_ID }}.pkl'
  cnofig_path: '/home/jovyan/shared-scratch/catlas/outputs/nitrides_CO2RR_{{ GITHUB_RUN_ID }}.yml'
  verbose: False

bulk_filters:
  filter_by_acceptable_elements: ['N', 'Sc', 'Ti', 'V', 'Cr', 'Mn', 'Fe', 'Co', 'Ni', 'Cu', 'Zn', 'Y', 'Zr', 'Nb', 'Mo', 'Tc', 'Ru', 'Rh', 'Pd', 'Ag', 'Cd', 'Ta', 'W', 'Re', 'Os', 'Ir', 'Pt', 'Au', 'Hg', 'Al', 'Ga', 'Sn', Pb', 'Bi', 'In']
  filter_by_object_size: 40 # 60
  filter_by_required_elements: ['N']

adsorbate_filters:
  filter_by_smiles: ['*H', '*CO','*OH','*CHO']

slab_filters:
  filter_by_object_size: 90
  filter_by_max_miller_index: 2

adslab_prediction_steps:
- step: predict
  type: direct
  gpu: true
  batch_size: 4
  label: 'dE_gemnet_is2re_finetuned'
  checkpoint_path: '/home/jovyan/catlas/configs/ocp_config_checkpoints/gemnet-is2re-finetuned-11-01.pt'

